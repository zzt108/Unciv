# Jobs to test the code base and build the client and server app
name: Build and test

on:
  # Triggers the workflow on any push or pull request
  push:
  pull_request:

jobs:

  # We only need the minimum

  code-checks:
    name: Check code and run unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          cache: 'gradle'
          distribution: 'temurin'
          java-version: 21

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Compile kotlin and build classes
        run: ./gradlew classes

      - name: Run code checks
        run: ./gradlew check

      - name: Run unit tests
        id: run_tests
        continue-on-error: true
        run: |
          ./gradlew --no-build-cache cleanTest test tests:test 2>&1 | tee test_output.log
          echo "test_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Extract test failures
        if: steps.run_tests.outputs.test_exit_code != '0'
        id: extract_failures
        run: |
          # Extract relevant failure information from test output
          FAILURE_CONTENT=$(awk '/FAILED|STANDARD_ERROR|STANDARD_OUT/{p=1} p{print} /^[[:space:]]*$/ && p{p=0}' test_output.log | head -100)

          # Save to file and create GitHub output
          echo "$FAILURE_CONTENT" > test_failures.txt

          # Create multiline output for GitHub
          echo "failures<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILURE_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment test failures on PR
        if: steps.run_tests.outputs.test_exit_code != '0' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failures = fs.readFileSync('test_failures.txt', 'utf8');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `## ‚ùå Test Failures Detected

            The following tests failed in this PR:

            \`\`\`
            ${failures}
            \`\`\`

            [View full test output](${runUrl})
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail workflow if tests failed
        if: steps.run_tests.outputs.test_exit_code != '0'
        run: exit 1
